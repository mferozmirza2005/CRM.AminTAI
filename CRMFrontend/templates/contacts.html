{% extends "base.html" %}

{% block title %}Contacts - CRM{% endblock %}

{% block content %}
<div class="page-header">
  <h2 class="mb-0">Contacts</h2>
  <button class="btn btn-primary" id="createBtn">
    <i class="bi bi-plus-lg me-2"></i>Create Contact
  </button>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="dataTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Account</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Created</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>    </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Create Contact</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="itemForm">
          <input type="hidden" id="itemId" />
          <div class="row">
            <div class="mb-3 col-6">
              <label class="form-label">First name</label>
              <input
                type="text"
                id="first_name"
                class="form-control"
                required
              />
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">Last name</label>
              <input type="text" id="last_name" class="form-control" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Account</label>
            <select id="account" class="form-select">
              <option value="">— Select account —</option>
            </select>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label class="form-label">Email</label>
              <input type="email" id="email" class="form-control" />
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">Phone</label>
              <input type="text" id="phone" class="form-control" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Position</label>
            <input type="text" id="position" class="form-control" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const base = "/api/contacts/";
    const token = () => localStorage.getItem("access");
    const modalEl = document.getElementById("itemModal");
    const modal = new bootstrap.Modal(modalEl);

    async function load() {
      try {
        const [rContacts, rAccounts] = await Promise.all([
          fetch(base, { headers: { Authorization: "Bearer " + token() } }),
          fetch("/api/accounts/", {
            headers: { Authorization: "Bearer " + token() },
          }),
        ]);
        if (!rContacts.ok) return console.error("Failed to load contacts", rContacts.status);

        // build accounts lookup and populate select
        let accounts = [];
        if (rAccounts.ok) {
          accounts = await rAccounts.json();
          const accountSelect = document.getElementById("account");
          accountSelect.innerHTML = '<option value="">— Select account —</option>';
          accounts.forEach((a) => {
            const opt = document.createElement("option");
            opt.value = a.id;
            opt.textContent = a.name;
            accountSelect.appendChild(opt);
          });
        }

        const data = await rContacts.json();
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = data
          .map((i) => {
            const fullName = (i.first_name || "") + (i.last_name ? " " + i.last_name : "");
            // account may be returned as nested object, as an ID in `account`, or as `account_id`
            let accountDisplay = "-";
            if (i.account) {
              const accObj = typeof i.account === "object" ? i.account : accounts.find((a) => a.id === i.account);
              if (accObj) accountDisplay = accObj.name;
            } else if (i.account_id) {
              const accObj = accounts.find((a) => a.id === i.account_id);
              if (accObj) accountDisplay = accObj.name;
            }

            return `
                    <tr data-id="${i.id}">
                        <td>${fullName}</td>
                        <td>${accountDisplay}</td>
                        <td>${i.email || "-"}</td>
                        <td>${i.phone || "-"}</td>
                        <td>${new Date(i.created_at).toLocaleDateString()}</td>
                        <td class="text-end">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary view-btn">View</button>
                                <button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>
                                <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");

        document.querySelectorAll(".view-btn").forEach((b) => b.addEventListener("click", onView));
        document.querySelectorAll(".edit-btn").forEach((b) => b.addEventListener("click", onEdit));
        document.querySelectorAll(".delete-btn").forEach((b) => b.addEventListener("click", onDelete));
      } catch (err) {
        console.error("Error loading contacts", err);
      }
    }

    function openCreate() {
      document.getElementById("modalTitle").textContent = "Create Contact";
      document.getElementById("itemForm").reset();
      document.getElementById("itemId").value = "";
      modal.show();
    }

    async function onView(e) {
      const id = e.target.closest("tr").dataset.id;
      const res = await fetch(base + id + "/", { headers: { Authorization: "Bearer " + token() } });
      if (!res.ok) return alert("Failed");
      const it = await res.json();
      document.getElementById("modalTitle").textContent = "View Contact";
      document.getElementById("first_name").value = it.first_name || "";
      document.getElementById("last_name").value = it.last_name || "";
      document.getElementById("account").value = it.account ? (typeof it.account === 'object' ? it.account.id : it.account) : (it.account_id || "");
      document.getElementById("email").value = it.email || "";
      document.getElementById("phone").value = it.phone || "";
      document.getElementById("position").value = it.position || "";
      Array.from(document.querySelectorAll("#itemForm input, #itemForm select")).forEach((i) => (i.disabled = true));
      document.getElementById("saveBtn").style.display = "none";
      modal.show();
    }

    async function onEdit(e) {
      const id = e.target.closest("tr").dataset.id;
      const res = await fetch(base + id + "/", { headers: { Authorization: "Bearer " + token() } });
      if (!res.ok) return alert("Failed");
      const it = await res.json();
      document.getElementById("modalTitle").textContent = "Edit Contact";
      document.getElementById("itemId").value = it.id;
      document.getElementById("first_name").value = it.first_name || "";
      document.getElementById("last_name").value = it.last_name || "";
      document.getElementById("account").value = it.account ? (typeof it.account === 'object' ? it.account.id : it.account) : (it.account_id || "");
      document.getElementById("email").value = it.email || "";
      document.getElementById("phone").value = it.phone || "";
      document.getElementById("position").value = it.position || "";
      Array.from(document.querySelectorAll("#itemForm input, #itemForm select")).forEach((i) => (i.disabled = false));
      document.getElementById("saveBtn").style.display = "";
      modal.show();
    }

    async function onDelete(e) {
      if (!confirm("Delete this contact?")) return;
      const id = e.target.closest("tr").dataset.id;
      const res = await fetch(base + id + "/", { method: "DELETE", headers: { Authorization: "Bearer " + token() } });
      if (res.ok || res.status === 204) e.target.closest("tr").remove();
      else alert("Delete failed");
    }

    async function save() {
      const id = document.getElementById("itemId").value;
      const payload = {
        first_name: document.getElementById("first_name").value,
        last_name: document.getElementById("last_name").value,
        account: document.getElementById("account").value || null,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        position: document.getElementById("position").value,
      };
      const opts = {
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token(),
        },
        body: JSON.stringify(payload),
      };
      let res;
      if (id) {
        opts.method = "PUT";
        res = await fetch(base + id + "/", opts);
      } else {
        opts.method = "POST";
        res = await fetch(base, opts);
      }
      if (res.ok) {
        modal.hide();
        load();
      } else {
        alert("Save failed");
      }
    }

    document.getElementById("createBtn").addEventListener("click", openCreate);
    document.getElementById("saveBtn").addEventListener("click", save);
    modalEl.addEventListener("hidden.bs.modal", () => {
      Array.from(document.querySelectorAll("#itemForm input, #itemForm select, #itemForm textarea")).forEach((i) => (i.disabled = false));
      document.getElementById("saveBtn").style.display = "";
    });

    load();
  })();
</script>
{% endblock %}
