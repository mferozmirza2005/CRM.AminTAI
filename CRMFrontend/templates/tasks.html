{% extends "base.html" %}

{% block title %}Tasks - CRM{% endblock %}

{% block content %}
<div class="page-header">
  <h2 class="mb-0">Tasks</h2>
  <button class="btn btn-primary" id="createBtn">
    <i class="bi bi-plus-lg me-2"></i>Create Task
  </button>
</div>

<div class="d-flex align-items-center gap-2 mb-3">
  <input type="search" id="searchInput" class="form-control" placeholder="Search tasks..." style="max-width: 320px;">
  <select id="completedFilter" class="form-select" style="max-width: 200px;">
    <option value="">All</option>
    <option value="true">Completed</option>
    <option value="false">Pending</option>
  </select>
  <select id="assigneeFilter" class="form-select" style="max-width: 220px;">
    <option value="">All assignees</option>
  </select>
  <button class="btn btn-outline-secondary" id="clearSearchBtn">Clear</button>
  <div class="ms-auto d-flex align-items-center gap-2">
    <button class="btn btn-outline-secondary btn-sm" id="prevPage">Prev</button>
    <span id="pageInfo" class="small text-muted"></span>
    <button class="btn btn-outline-secondary btn-sm" id="nextPage">Next</button>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="dataTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Assigned</th>
            <th>Due</th>
            <th>Completed</th>
            <th>Created</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody> </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Create Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="itemForm">
          <input type="hidden" id="itemId" />
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" id="title" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="description" class="form-control" rows="3"></textarea>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label class="form-label">Assigned to</label>
              <select id="assigned_to" class="form-select">
                <option value="">— None —</option>
              </select>
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">Due date</label>
              <input type="date" id="due_date" class="form-control" />
            </div>
          </div>
          <div class="mb-3 form-check">
            <input class="form-check-input" type="checkbox" id="completed" />
            <label class="form-check-label" for="completed">Completed</label>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label class="form-label">Related Lead</label>
              <select id="related_lead" class="form-select">
                <option value="">— None —</option>
              </select>
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">Related Deal</label>
              <select id="related_deal" class="form-select">
                <option value="">— None —</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label class="form-label">Related Campaign</label>
              <select id="related_campaign" class="form-select">
                <option value="">— None —</option>
              </select>
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">Related Account</label>
              <select id="related_account" class="form-select">
                <option value="">— None —</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const base = "/api/tasks/";
    const token = () => localStorage.getItem("access");
    const modalEl = document.getElementById("itemModal");
    const modal = new bootstrap.Modal(modalEl);
    let currentPage = 1;
    let lastQuery = "";
    let completedFilter = "";
    let assigneeFilter = "";

    async function load() {
      try {
        const [rTasks, rUsers, rLeads, rDeals, rCampaigns, rAccounts] =
          await Promise.all([
            fetch(`${base}?page=${currentPage}${lastQuery ? `&q=${encodeURIComponent(lastQuery)}` : ''}${completedFilter ? `&completed=${encodeURIComponent(completedFilter)}` : ''}${assigneeFilter ? `&assigned_to=${encodeURIComponent(assigneeFilter)}` : ''}`, { headers: { Authorization: "Bearer " + token() } }),
            fetch("/api/users/", {
              headers: { Authorization: "Bearer " + token() },
            }),
            fetch("/api/leads/", {
              headers: { Authorization: "Bearer " + token() },
            }),
            fetch("/api/deals/", {
              headers: { Authorization: "Bearer " + token() },
            }),
            fetch("/api/campaigns/", {
              headers: { Authorization: "Bearer " + token() },
            }),
            fetch("/api/accounts/", {
              headers: { Authorization: "Bearer " + token() },
            }),
          ]);
        if (!rTasks.ok)
          return console.error("Failed to load tasks", rTasks.status);

        // Store users for lookup when rendering table
        let users = [];
        if (rUsers.ok) {
          const usersRaw = await rUsers.json();
          users = Array.isArray(usersRaw) ? usersRaw : (usersRaw.results || []);
          const sel = document.getElementById("assigned_to");
          sel.innerHTML = '<option value="">— None —</option>';
          const assigneeFilterSel = document.getElementById("assigneeFilter");
          // reset filter options keeping default and restore previous selection
          if (assigneeFilterSel) {
            const prevVal = assigneeFilterSel.value;
            assigneeFilterSel.innerHTML = '<option value="">All assignees</option>';
            // append options after resetting
            users.forEach((u) => {
              assigneeFilterSel.appendChild(new Option(((u.first_name || "") + (u.last_name ? " " + u.last_name : "")).trim() || u.email || '-', u.id));
            });
            if (prevVal) assigneeFilterSel.value = prevVal;
          }
          users.forEach((u) =>
            sel.appendChild(
              new Option(
                (
                  (u.first_name || "") + (u.last_name ? " " + u.last_name : "")
                ).trim() +
                " <" +
                u.email +
                ">",
                u.id
              )
            )
          );
        }
        if (rLeads.ok) {
          const leadsRaw = await rLeads.json();
          const leads = Array.isArray(leadsRaw) ? leadsRaw : (leadsRaw.results || []);
          const sel = document.getElementById("related_lead");
          leads.forEach((l) => sel.appendChild(new Option(l.title, l.id)));
        }
        if (rDeals.ok) {
          const dealsRaw = await rDeals.json();
          const deals = Array.isArray(dealsRaw) ? dealsRaw : (dealsRaw.results || []);
          const sel = document.getElementById("related_deal");
          deals.forEach((d) => sel.appendChild(new Option(d.title, d.id)));
        }
        if (rCampaigns.ok) {
          const campsRaw = await rCampaigns.json();
          const camps = Array.isArray(campsRaw) ? campsRaw : (campsRaw.results || []);
          const sel = document.getElementById("related_campaign");
          camps.forEach((c) => sel.appendChild(new Option(c.name, c.id)));
        }
        if (rAccounts.ok) {
          const accsRaw = await rAccounts.json();
          const accs = Array.isArray(accsRaw) ? accsRaw : (accsRaw.results || []);
          const sel = document.getElementById("related_account");
          accs.forEach((a) => sel.appendChild(new Option(a.name, a.id)));
        }

        const raw = await rTasks.json();
        const data = Array.isArray(raw) ? raw : (raw.results || []);
        const total = Array.isArray(raw) ? data.length : (raw.count || data.length);
        const pageSize = Array.isArray(raw) ? data.length : (raw.results ? raw.results.length : data.length);
        const totalPages = pageSize ? Math.ceil(total / pageSize) : 1;
        document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById("prevPage").disabled = currentPage <= 1;
        document.getElementById("nextPage").disabled = currentPage >= totalPages;
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = data
          .map((i) => {
            // Handle assigned_to display - may be object or ID
            let assignedDisplay = "-";
            if (i.assigned_to) {
              // Owner may be an object or an ID
              const assignedObj = typeof i.assigned_to === 'object' ? i.assigned_to :
                (users.length > 0 ? users.find((u) => u.id === Number(i.assigned_to)) : null);
              if (assignedObj) {
                assignedDisplay = ((assignedObj.first_name || "") + (assignedObj.last_name ? " " + assignedObj.last_name : "")).trim() || assignedObj.email || "-";
              }
            } else if (i.assigned_to_id && users.length > 0) {
              const assignedObj = users.find((u) => u.id === Number(i.assigned_to_id));
              if (assignedObj) {
                assignedDisplay = ((assignedObj.first_name || "") + (assignedObj.last_name ? " " + assignedObj.last_name : "")).trim() || assignedObj.email || "-";
              }
            }

            return `
                    <tr data-id="${i.id}">
                        <td>${i.title}</td>
                        <td>${assignedDisplay}</td>
                        <td>${i.due_date
                ? new Date(i.due_date).toLocaleDateString()
                : "-"
              }</td>
                        <td>${i.completed ? "✅" : "❌"}</td>
                        <td>${new Date(i.created_at).toLocaleDateString()}</td>
                        <td class="text-end">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary view-btn">View</button>
                                <button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>
                                <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");

        document
          .querySelectorAll(".view-btn")
          .forEach((b) => b.addEventListener("click", onView));
        document
          .querySelectorAll(".edit-btn")
          .forEach((b) => b.addEventListener("click", onEdit));
        document
          .querySelectorAll(".delete-btn")
          .forEach((b) => b.addEventListener("click", onDelete));
      } catch (err) {
        console.error("Error loading tasks", err);
      }
    }

    // Search & filters
    const searchInput = document.getElementById("searchInput");
    const completedSel = document.getElementById("completedFilter");
    const assigneeSel = document.getElementById("assigneeFilter");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    let searchTimer;
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        lastQuery = searchInput.value.trim();
        currentPage = 1;
        load();
      }, 300);
    });
    completedSel.addEventListener("change", () => {
      completedFilter = completedSel.value || "";
      currentPage = 1;
      load();
    });
    assigneeSel.addEventListener("change", () => {
      assigneeFilter = assigneeSel.value || "";
      currentPage = 1;
      load();
    });
    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = "";
      lastQuery = "";
      completedSel.value = "";
      assigneeSel.value = "";
      completedFilter = "";
      assigneeFilter = "";
      currentPage = 1;
      load();
    });
    document.getElementById("prevPage").addEventListener("click", () => { if (currentPage > 1) { currentPage -= 1; load(); } });
    document.getElementById("nextPage").addEventListener("click", () => { currentPage += 1; load(); });

    function openCreate() {
      document.getElementById("modalTitle").textContent = "Create Task";
      document.getElementById("itemForm").reset();
      document.getElementById("itemId").value = "";
      modal.show();
    }

    async function onView(e) {
      const id = e.target.closest("tr").dataset.id;
      const res = await fetch(base + id + "/", {
        headers: { Authorization: "Bearer " + token() },
      });
      if (!res.ok) return alert("Failed");
      const it = await res.json();
      document.getElementById("modalTitle").textContent = "View Task";
      document.getElementById("title").value = it.title || "";
      document.getElementById("description").value = it.description || "";
      document.getElementById("assigned_to").value = it.assigned_to ? String(it.assigned_to.id) : "";
      document.getElementById("due_date").value = it.due_date || "";
      document.getElementById("completed").checked = !!it.completed;
      document.getElementById("related_lead").value = it.related_lead ? String(it.related_lead.id) : "";
      document.getElementById("related_deal").value = it.related_deal ? String(it.related_deal.id) : "";
      document.getElementById("related_campaign").value = it.related_campaign ? String(it.related_campaign.id) : "";
      document.getElementById("related_account").value = it.related_account ? String(it.related_account.id) : "";
      Array.from(
        document.querySelectorAll(
          "#itemForm input, #itemForm textarea, #itemForm select"
        )
      ).forEach((i) => (i.disabled = true));
      document.getElementById("saveBtn").style.display = "none";
      modal.show();
    }

    async function onEdit(e) {
      const id = e.target.closest("tr").dataset.id;
      const res = await fetch(base + id + "/", {
        headers: { Authorization: "Bearer " + token() },
      });
      if (!res.ok) return alert("Failed");
      const it = await res.json();
      document.getElementById("modalTitle").textContent = "Edit Task";
      document.getElementById("itemId").value = it.id;
      document.getElementById("title").value = it.title || "";
      document.getElementById("description").value = it.description || "";
      document.getElementById("assigned_to").value = it.assigned_to ? String(it.assigned_to.id) : "";
      document.getElementById("due_date").value = it.due_date || "";
      document.getElementById("completed").checked = !!it.completed;
      document.getElementById("related_lead").value = it.related_lead ? String(it.related_lead.id) : "";
      document.getElementById("related_deal").value = it.related_deal ? String(it.related_deal.id) : "";
      document.getElementById("related_campaign").value = it.related_campaign ? String(it.related_campaign.id) : "";
      document.getElementById("related_account").value = it.related_account ? String(it.related_account.id) : "";
      Array.from(
        document.querySelectorAll(
          "#itemForm input, #itemForm textarea, #itemForm select"
        )
      ).forEach((i) => (i.disabled = false));
      document.getElementById("saveBtn").style.display = "";
      modal.show();
    }

    async function onDelete(e) {
      if (!confirm("Delete this task?")) return;
      const id = e.target.closest("tr").dataset.id;
      const res = await fetch(base + id + "/", {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token() },
      });
      if (res.ok || res.status === 204) e.target.closest("tr").remove();
      else alert("Delete failed");
    }

    async function save() {
      const id = document.getElementById("itemId").value;
      const payload = {
        title: document.getElementById("title").value,
        description: document.getElementById("description").value,
        assigned_to: document.getElementById("assigned_to").value || null,
        due_date: document.getElementById("due_date").value || null,
        completed: document.getElementById("completed").checked,
        related_lead: document.getElementById("related_lead").value || null,
        related_deal: document.getElementById("related_deal").value || null,
        related_campaign:
          document.getElementById("related_campaign").value || null,
        related_account:
          document.getElementById("related_account").value || null,
      };
      const opts = {
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token(),
        },
        body: JSON.stringify(payload),
      };
      let res;
      if (id) {
        opts.method = "PUT";
        res = await fetch(base + id + "/", opts);
      } else {
        opts.method = "POST";
        res = await fetch(base, opts);
      }
      if (res.ok) {
        modal.hide();
        load();
      } else {
        alert("Save failed");
      }
    }

    document.getElementById("createBtn").addEventListener("click", openCreate);
    document.getElementById("saveBtn").addEventListener("click", save);
    modalEl.addEventListener("hidden.bs.modal", () => {
      Array.from(
        document.querySelectorAll(
          "#itemForm input, #itemForm select, #itemForm textarea"
        )
      ).forEach((i) => (i.disabled = false));
      document.getElementById("saveBtn").style.display = "";
    });

    load();
  })();
</script>
{% endblock %}