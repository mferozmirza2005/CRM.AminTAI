{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block content %}
<div class="page-header">
  <h2 class="mb-0">User Management</h2>
  {% if request.user.is_superuser %}
  <button class="btn btn-primary" id="createUserBtn">
    <i class="bi bi-person-plus me-2"></i>Create User
  </button>
  {% endif %}
</div>

<div class="d-flex align-items-center gap-2 mb-3">
  <input type="search" id="searchInput" class="form-control" placeholder="Search users..." style="max-width: 320px;">
  <select id="roleFilter" class="form-select" style="max-width: 220px;">
    <option value="">All roles</option>
    <option value="SUPERADMIN">Super Admin</option>
    <option value="ADMIN">Admin</option>
    <option value="EMPLOYEE">Employee</option>
  </select>
  <button class="btn btn-outline-secondary" id="clearSearchBtn">Clear</button>
  <div class="ms-auto d-flex align-items-center gap-2">
    <button class="btn btn-outline-secondary btn-sm" id="prevPage">Prev</button>
    <span id="pageInfo" class="small text-muted"></span>
    <button class="btn btn-outline-secondary btn-sm" id="nextPage">Next</button>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle" id="userTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody> </tbody>
      </table>
    </div>
  </div>
</div>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userModalTitle">Create User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <input type="hidden" id="userId" />
          <div class="row">
            <div class="mb-3 col-6">
              <label class="form-label">First name</label>
              <input type="text" id="first_name" class="form-control" />
            </div>
            <div class="mb-3 col-6">
              <label class="form-label">Last name</label>
              <input type="text" id="last_name" class="form-control" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Password
              <small class="text-muted">(leave empty to keep current)</small></label>
            <input type="password" id="password" class="form-control" />
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="role" class="form-select">
              <option value="SUPERADMIN">Super Admin</option>
              <option value="ADMIN">Admin</option>
              <option value="EMPLOYEE">Employee</option>
            </select>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="is_active" checked />
            <label class="form-check-label" for="is_active">Active</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary" id="saveUserBtn">
          Save
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const apiBase = "/api/users/";
    const token = () => localStorage.getItem("access");
    const headers = (extra = {}) =>
      Object.assign(
        {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token(),
        },
        extra
      );

    const modalEl = document.getElementById("userModal");
    const userModal = new bootstrap.Modal(modalEl);

    let currentPage = 1;
    let lastQuery = "";
    let roleFilter = "";

    async function loadUsers() {
      const res = await fetch(`${apiBase}?page=${currentPage}${lastQuery ? `&q=${encodeURIComponent(lastQuery)}` : ''}${roleFilter ? `&role=${encodeURIComponent(roleFilter)}` : ''}`, {
        headers: { Authorization: "Bearer " + token() },
      });
      if (!res.ok) return console.error("Failed to load users", res.status);
      const raw = await res.json();
      const data = Array.isArray(raw) ? raw : (raw.results || []);
      const total = Array.isArray(raw) ? data.length : (raw.count || data.length);
      const pageSize = Array.isArray(raw) ? data.length : (raw.results ? raw.results.length : data.length);
      const totalPages = pageSize ? Math.ceil(total / pageSize) : 1;
      document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPages;
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = data
        .map(
          (u) => `
                    <tr data-id="${u.id}">
                        <td>${(u.first_name || "") +
            (u.last_name ? " " + u.last_name : "") || "-"
            }</td>
                        <td>${u.email || "-"}</td>
                        <td>${u.role || "-"}</td>
                        <td>${u.is_active ? "Active" : "Inactive"}</td>
                        <td class="text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-secondary view-btn">View</button>
                                <button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>
                                <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                            </div>
                        </td>
                    </tr>
                `
        )
        .join("");

      // attach handlers
      document
        .querySelectorAll(".view-btn")
        .forEach((b) => b.addEventListener("click", onView));
      document
        .querySelectorAll(".edit-btn")
        .forEach((b) => b.addEventListener("click", onEdit));
      document
        .querySelectorAll(".delete-btn")
        .forEach((b) => b.addEventListener("click", onDelete));
    }

    // Search & filters
    const searchInput = document.getElementById("searchInput");
    const roleSel = document.getElementById("roleFilter");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    let searchTimer;
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        lastQuery = searchInput.value.trim();
        currentPage = 1;
        loadUsers();
      }, 300);
    });
    roleSel.addEventListener("change", () => {
      roleFilter = roleSel.value || "";
      currentPage = 1;
      loadUsers();
    });
    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = "";
      lastQuery = "";
      roleSel.value = "";
      roleFilter = "";
      currentPage = 1;
      loadUsers();
    });
    document.getElementById("prevPage").addEventListener("click", () => { if (currentPage > 1) { currentPage -= 1; loadUsers(); } });
    document.getElementById("nextPage").addEventListener("click", () => { currentPage += 1; loadUsers(); });

    async function onView(e) {
      const row = e.target.closest("tr");
      const id = row.dataset.id;
      const res = await fetch(apiBase + id + "/", {
        headers: { Authorization: "Bearer " + token() },
      });
      if (!res.ok) return alert("Failed to fetch user");
      const u = await res.json();
      document.getElementById(
        "userModalTitle"
      ).textContent = `View: ${u.email}`;
      document.getElementById("first_name").value = u.first_name || "";
      document.getElementById("last_name").value = u.last_name || "";
      document.getElementById("email").value = u.email || "";
      document.getElementById("role").value = u.role || "";
      document.getElementById("is_active").checked = !!u.is_active;
      document.getElementById("password").value = "";
      // disable inputs when viewing
      Array.from(
        document.querySelectorAll("#userForm input, #userForm select")
      ).forEach((i) => (i.disabled = true));
      document.getElementById("saveUserBtn").style.display = "none";
      userModal.show();
    }

    function openCreate() {
      document.getElementById("userModalTitle").textContent = "Create User";
      document.getElementById("userForm").reset();
      document.getElementById("userId").value = "";
      Array.from(
        document.querySelectorAll("#userForm input, #userForm select")
      ).forEach((i) => (i.disabled = false));
      document.getElementById("saveUserBtn").style.display = "";
      userModal.show();
    }

    async function onEdit(e) {
      const row = e.target.closest("tr");
      const id = row.dataset.id;
      const res = await fetch(apiBase + id + "/", {
        headers: { Authorization: "Bearer " + token() },
      });
      if (!res.ok) return alert("Failed to fetch user");
      const u = await res.json();
      document.getElementById(
        "userModalTitle"
      ).textContent = `Edit: ${u.email}`;
      document.getElementById("userId").value = u.id;
      document.getElementById("first_name").value = u.first_name || "";
      document.getElementById("last_name").value = u.last_name || "";
      document.getElementById("email").value = u.email || "";
      document.getElementById("role").value = u.role || "";
      document.getElementById("is_active").checked = !!u.is_active;
      document.getElementById("password").value = "";
      Array.from(
        document.querySelectorAll("#userForm input, #userForm select")
      ).forEach((i) => (i.disabled = false));
      document.getElementById("saveUserBtn").style.display = "";
      userModal.show();
    }

    async function onDelete(e) {
      if (!confirm("Delete this user?")) return;
      const row = e.target.closest("tr");
      const id = row.dataset.id;
      const res = await fetch(apiBase + id + "/", {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token() },
      });
      if (res.status === 204 || res.ok) {
        row.remove();
      } else {
        alert("Failed to delete user");
      }
    }

    async function saveUser() {
      const id = document.getElementById("userId").value;
      const payload = {
        first_name: document.getElementById("first_name").value,
        last_name: document.getElementById("last_name").value,
        email: document.getElementById("email").value,
        role: document.getElementById("role").value,
        is_active: document.getElementById("is_active").checked,
      };
      const pwd = document.getElementById("password").value;
      if (pwd) payload.password = pwd;

      const opts = {
        headers: headers(),
        body: JSON.stringify(payload),
      };

      let res;
      if (id) {
        opts.method = "PUT";
        res = await fetch(apiBase + id + "/", opts);
      } else {
        opts.method = "POST";
        res = await fetch(apiBase, opts);
      }

      if (res.ok) {
        userModal.hide();
        await loadUsers();
      } else {
        const err = await res.text();
        alert("Error saving user: " + err);
      }
    }

    document.getElementById("saveUserBtn").addEventListener("click", saveUser);
    const createBtn = document.getElementById("createUserBtn");
    if (createBtn) createBtn.addEventListener("click", openCreate);

    // hide modal cleanup: re-enable inputs and show save button
    modalEl.addEventListener("hidden.bs.modal", () => {
      Array.from(
        document.querySelectorAll("#userForm input, #userForm select")
      ).forEach((i) => (i.disabled = false));
      document.getElementById("saveUserBtn").style.display = "";
    });

    // initial load
    loadUsers();
  })();
</script>
{% endblock %}